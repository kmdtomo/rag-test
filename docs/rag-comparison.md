# RAG最適化版と統合版の機能比較

## 概要

本ドキュメントでは、RAG（Retrieval-Augmented Generation）システムの2つの実装方式について、ナレッジベースとLLMの機能の行き来を明確にしながら比較します。

## アーキテクチャの違い

### RAG最適化版（rag-optimized）

```
ユーザー → API → クエリ分解（Haiku） → ナレッジベース検索（複数回） → 再ランキング → LLM生成（Claude） → レスポンス
```

**特徴：**
- 検索と生成を分離した実装
- 複数のAWSクライアントを使用（BedrockAgentRuntimeClient + BedrockRuntimeClient）
- きめ細かい制御が可能

### RAG統合版（rag-integrated）

```
ユーザー → API → RetrieveAndGenerateCommand → ナレッジベース検索＋LLM生成（一体化） → レスポンス
```

**特徴：**
- AWSマネージドな一体型実装
- 単一のRetrieveAndGenerateCommandで処理
- シンプルだが柔軟性は限定的

## 機能フローの詳細比較

### 1. クエリ処理フロー

#### RAG最適化版
1. **クエリ分解**（Claude Haiku使用）
   - 複雑な質問をサブクエリに分解
   - 例：「製品Aの価格と機能を教えて」→「製品Aの価格」「製品Aの機能」
   
2. **ナレッジベース検索**（複数回実行）
   - 各サブクエリごとに独立して検索
   - ハイブリッド検索（ベクトル検索＋キーワード検索）を使用
   - 検索結果の重複を除去

3. **再ランキング**
   - スコアと内容の長さを考慮した独自アルゴリズム
   - 最も関連性の高い上位10件を選択

4. **LLM生成**（Claude Sonnet/Haiku選択可）
   - カスタムプロンプトテンプレートを使用
   - 検索結果を構造化して提示

#### RAG統合版
1. **一体型処理**
   - RetrieveAndGenerateCommandに質問を渡すだけ
   - AWSが内部で検索と生成を最適化
   - セッション管理機能付き（会話の継続性）

### 2. ナレッジベースとLLMの連携方式

#### RAG最適化版の連携
```
ナレッジベース（検索） → 中間処理層（最適化） → LLM（生成）
```
- **メリット**：
  - 検索結果を詳細に制御可能
  - 独自の最適化ロジックを実装可能
  - デバッグが容易

- **デメリット**：
  - 実装が複雑
  - レイテンシが増加する可能性

#### RAG統合版の連携
```
ナレッジベース ←→ LLM（AWS内部で自動連携）
```
- **メリット**：
  - シンプルな実装
  - AWSによる最適化済み
  - レイテンシが低い

- **デメリット**：
  - カスタマイズが限定的
  - 内部処理がブラックボックス

## コスト比較

### API呼び出しコスト（1回のリクエストあたり）

#### RAG最適化版
| コンポーネント | 使用量 | 単価 | コスト |
|------------|--------|------|-------|
| Claude Haiku（クエリ分解） | 0.5K トークン | $0.00025/1K | $0.000125 |
| ナレッジベース検索 | 3-5回 | $0.00025/検索 | $0.00125 |
| Claude Sonnet（生成） | 4K トークン | $0.003/1K | $0.012 |
| **合計** | | | **$0.013375** |

#### RAG統合版
| コンポーネント | 使用量 | 単価 | コスト |
|------------|--------|------|-------|
| RetrieveAndGenerate | 1回 | $0.00025/検索 | $0.00025 |
| Claude Sonnet（統合生成） | 4K トークン | $0.003/1K | $0.012 |
| **合計** | | | **$0.01225** |

### コスト差分析
- **差額**：約$0.001125/リクエスト（最適化版が約9%高い）
- **月間10万リクエストの場合**：約$112.5の差

## 使い分けガイドライン

### RAG最適化版を選ぶべきケース
1. **複雑な質問への対応が必要**
   - 複数の観点を含む質問
   - 高精度な回答が求められる場合

2. **検索結果の詳細な制御が必要**
   - 独自のランキングアルゴリズム
   - 検索結果のフィルタリング

3. **デバッグ・監視が重要**
   - 各ステップの詳細なログ
   - パフォーマンスチューニング

### RAG統合版を選ぶべきケース
1. **シンプルな実装を優先**
   - 開発期間が短い
   - メンテナンスコストを削減

2. **標準的なRAG機能で十分**
   - 一般的な質問応答
   - セッション管理が必要

3. **コスト効率を重視**
   - 大量のリクエスト処理
   - 予算制約がある

## パフォーマンス比較

| 指標 | RAG最適化版 | RAG統合版 |
|-----|------------|----------|
| レスポンス時間 | 3-5秒 | 2-3秒 |
| 回答の詳細度 | 高 | 中 |
| カスタマイズ性 | 高 | 低 |
| 実装の複雑さ | 高 | 低 |
| 運用コスト | やや高 | 低 |

## まとめ

- **RAG最適化版**：高度な制御と最適化が可能だが、実装が複雑でコストがやや高い
- **RAG統合版**：シンプルで低コストだが、カスタマイズ性に制限がある

プロジェクトの要件（精度、コスト、開発期間）に応じて適切な実装を選択することが重要です。